# Redis Cluster Configuration
# Production-ready persistence settings

# ========================================
# PERSISTENCE - Dual Strategy (RDB + AOF)
# ========================================

# AOF (Append-Only File) - Better durability
appendonly yes
appendfsync everysec              # Fsync every second (good balance)
auto-aof-rewrite-percentage 100   # Rewrite when AOF grows 100%
auto-aof-rewrite-min-size 64mb    # Don't rewrite if AOF < 64MB
aof-use-rdb-preamble yes          # Hybrid RDB+AOF for faster restart

# RDB (Snapshot) - Backup strategy
save 900 1        # Save if 1 key changed in 15 minutes
save 300 10       # Save if 10 keys changed in 5 minutes
save 60 10000     # Save if 10000 keys changed in 1 minute
stop-writes-on-bgsave-error yes   # Stop writes if save fails
rdbcompression yes                # Compress RDB files
rdbchecksum yes                   # Checksum validation

# ========================================
# CLUSTER SETTINGS
# ========================================
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
cluster-require-full-coverage no  # Allow reads even if some slots down

# ========================================
# SECURITY
# ========================================
requirepass redis_password_2024
masterauth redis_password_2024

# ========================================
# MEMORY MANAGEMENT
# ========================================
maxmemory 512mb
maxmemory-policy allkeys-lru      # Evict least recently used keys

# ========================================
# PERFORMANCE
# ========================================
timeout 300                       # Close idle clients after 5 minutes
tcp-keepalive 300                 # TCP keepalive
tcp-backlog 511                   # Connection backlog

# Slow log (log queries slower than 10ms)
slowlog-log-slower-than 10000
slowlog-max-len 128

# ========================================
# GENERAL
# ========================================
daemonize no                      # Docker requires foreground
dir /data
logfile ""
loglevel notice
